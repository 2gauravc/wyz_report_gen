<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School Fitness Summary Report</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{ --text:#111; --muted:#666; --line:#ddd; --card:#fff; --bg:#f6f7f9; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--text); background:var(--bg); }
    .page{ max-width:1100px; margin:20px auto; padding:0 16px 24px; }

    header{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px 18px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
    }
    h1{ margin:0 0 6px 0; font-size:20px; }
    .sub{ color:var(--muted); font-size:13px; line-height:1.4; }
    .meta{ margin-top:6px; color:var(--muted); font-size:13px; }

    .filters{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:flex-start;
    }
    select{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 10px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      min-width:140px;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }

    .grid{ margin-top:14px; display:grid; grid-template-columns: 1.05fr .95fr; gap:14px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .card h2{ margin:0 0 10px 0; font-size:15px; }

    .kpis{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .kpi{ border:1px solid var(--line); border-radius:12px; padding:10px; background:#fff; }
    .kpi .label{ color:var(--muted); font-size:12px; margin-bottom:6px; }
    .kpi .value{ font-size:18px; font-weight:900; }
    .kpi .small{ color:var(--muted); font-size:12px; margin-top:6px; }

    .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px; }

    table{ width:100%; border-collapse:collapse; font-size:12.5px; }
    th, td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; }
    th{ color:var(--muted); font-size:12px; font-weight:900; text-transform:uppercase; letter-spacing:.3px; }
    .note{ margin-top:8px; font-size:12px; color:var(--muted); line-height:1.35; }

    @media print{
      body{ background:#fff; }
      .page{ max-width:none; margin:0; padding:0; }
      header{ border:none; border-bottom:2px solid #000; border-radius:0; }
      .filters{ display:none; }
      .grid{ grid-template-columns:1fr; }
      .card{ break-inside:avoid; }
      canvas{ max-height:240px !important; }
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div>
        <h1>School Fitness Summary Report</h1>
        <div class="sub">Use filters to view a specific grade / class / section and/or gender split.</div>
        <div class="meta">Generated: <b>{{ generated_at }}</b></div>
      </div>

      <div class="filters">
        <select id="gradeSel">
          <option value="">All Grades</option>
          {% for g in grades %}<option value="{{ g }}">{{ g }}</option>{% endfor %}
        </select>

        <select id="classSel">
          <option value="">All Classes</option>
          {% for c in classes %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
        </select>

        <select id="sectionSel">
          <option value="">All Sections</option>
          {% for s in sections %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
        </select>

        <select id="genderSel">
          <option value="">Boys vs Girls</option>
          <option value="Boy">Only Boys</option>
          <option value="Girl">Only Girls</option>
        </select>

        <button class="btn" onclick="window.print()">Print / Save PDF</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Overview</h2>

        <div class="kpis" id="kpis"></div>

        <div class="two-col">
          <div>
            <h2 style="margin-top:12px;">Fitness Score Distribution</h2>
            <canvas id="fitnessHist" height="180"></canvas>
            <div class="note">Histogram uses <code>fitnessscore</code> for the filtered set.</div>
          </div>
          <div>
            <h2 style="margin-top:12px;">Key Averages (Boys vs Girls)</h2>
            <canvas id="avgBar" height="180"></canvas>
            <div class="note">Height, Weight, Fitness Score, Run Speed Score, Pro Agility Score.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Component Snapshot (Boys vs Girls)</h2>
        <canvas id="radar" height="220"></canvas>
        <div class="note">Uses *_score columns where present.</div>

        <h2 style="margin-top:14px;">By Gender – Core Stats</h2>
        <table id="genderTable"></table>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Top Insights</h2>
      <ul id="insights"></ul>
      <div class="note">Insights update based on filters.</div>
    </div>
  </div>

  <script>
    // Embedded data from Python
    const ALL_ROWS = {{ rows_json | safe }};
    const INITIAL_STATS = {{ stats_json | safe }};

    const TEST_BEST_COLS = [
      "chairsquat_best","ohmbp_best","sbj_best","smbt_best","runspeed_best","proagility_best",
      "slr_best","shouldermob_best","baleyesopen_best"
    ];

    const AVG_BAR = [
      ["height", "Height (cm)"],
      ["weight", "Weight (kg)"],
      ["fitnessscore", "Fitness Score"],
      ["runspeed_score", "Run Speed Score"],
      ["proagility_score", "Pro Agility Score"]
    ];

    const RADAR = [
      ["chairsquat_score", "Chair Squat"],
      ["ohmbp_score", "OHMBP"],
      ["sbj_score", "SBJ"],
      ["smbt_score", "SMBT"],
      ["runspeed_score", "Run Speed"],
      ["proagility_score", "Pro Agility"],
      ["slr_score", "SLR"],
      ["shouldermob_score", "Shoulder Mob"],
      ["baleyesopen_score", "Balance"]
    ];

    function toNum(x){
      const n = Number(String(x ?? "").trim());
      return Number.isFinite(n) ? n : NaN;
    }
    function mean(arr){
      const xs = arr.filter(v => Number.isFinite(v));
      if (!xs.length) return NaN;
      return xs.reduce((a,b)=>a+b,0)/xs.length;
    }
    function pct(arr, p){
      const xs = arr.filter(v => Number.isFinite(v)).sort((a,b)=>a-b);
      if (!xs.length) return NaN;
      const idx = (p/100)*(xs.length-1);
      const lo = Math.floor(idx), hi = Math.ceil(idx);
      if (lo === hi) return xs[lo];
      const w = idx - lo;
      return xs[lo]*(1-w) + xs[hi]*w;
    }
    function median(arr){ return pct(arr, 50); }
    function histogram(values, bins=8){
      const xs = values.filter(v => Number.isFinite(v));
      if (!xs.length) return {labels:[], counts:[]};
      let min = Math.min(...xs), max = Math.max(...xs);
      if (min === max) return {labels:[String(min)], counts:[xs.length]};
      const step = (max - min) / bins;
      const counts = new Array(bins).fill(0);
      for (const v of xs){
        let idx = Math.floor((v - min) / step);
        if (idx === bins) idx = bins-1;
        counts[idx]++;
      }
      const labels = counts.map((_,i)=>{
        const a = min + i*step;
        const b = a + step;
        return `${a.toFixed(0)}–${b.toFixed(0)}`;
      });
      return {labels, counts};
    }
    function computeBMI(hCm, wKg){
      if (!Number.isFinite(hCm) || !Number.isFinite(wKg) || hCm <= 0) return NaN;
      const m = hCm / 100;
      return wKg/(m*m);
    }
    function missingAnyTest(r){
      for (const c of TEST_BEST_COLS){
        const v = toNum(r[c]);
        if (!Number.isFinite(v)) return true;
      }
      return false;
    }

    function computeStats(rows){
      const heights = rows.map(r => toNum(r.height));
      const weights = rows.map(r => toNum(r.weight));
      const fitness = rows.map(r => toNum(r.fitnessscore));
      const bmis = rows.map(r => computeBMI(toNum(r.height), toNum(r.weight)));
      const missPct = rows.length ? (rows.filter(missingAnyTest).length / rows.length)*100 : NaN;

      return {
        n: rows.length,
        avg_height: mean(heights),
        med_height: median(heights),
        p75_height: pct(heights, 75),
        avg_weight: mean(weights),
        med_weight: median(weights),
        p75_weight: pct(weights, 75),
        avg_bmi: mean(bmis),
        med_bmi: median(bmis),
        p75_bmi: pct(bmis, 75),
        avg_fitness: mean(fitness),
        med_fitness: median(fitness),
        p75_fitness: pct(fitness, 75),
        pct_missing_any: missPct
      };
    }

    function fmt(x, d=1){
      if (x === null || x === undefined || !Number.isFinite(x)) return "—";
      return Number(x).toFixed(d);
    }

    // Charts
    let CH = {hist:null, bar:null, radar:null};
    function destroyCharts(){
      for (const k of Object.keys(CH)){
        if (CH[k]) { CH[k].destroy(); CH[k]=null; }
      }
    }

    function renderKPIs(statsAll){
      const el = document.getElementById("kpis");
      el.innerHTML = `
        <div class="kpi"><div class="label">Students</div><div class="value">${statsAll.n}</div><div class="small">Filtered set</div></div>
        <div class="kpi"><div class="label">Avg Height</div><div class="value">${fmt(statsAll.avg_height,1)}</div><div class="small">cm</div></div>
        <div class="kpi"><div class="label">Avg Weight</div><div class="value">${fmt(statsAll.avg_weight,1)}</div><div class="small">kg</div></div>
        <div class="kpi"><div class="label">Avg Fitness Score</div><div class="value">${fmt(statsAll.avg_fitness,1)}</div><div class="small">All students</div></div>
        <div class="kpi"><div class="label">% With Missing Tests</div><div class="value">${fmt(statsAll.pct_missing_any,1)}%</div><div class="small">≥1 missing test</div></div>
        <div class="kpi"><div class="label">Avg BMI</div><div class="value">${fmt(statsAll.avg_bmi,1)}</div><div class="small">kg/m²</div></div>
      `;
    }

    function renderGenderTable(boysStats, girlsStats){
      const t = document.getElementById("genderTable");
      t.innerHTML = `
        <thead>
          <tr><th>Metric</th><th>Boys</th><th>Girls</th></tr>
        </thead>
        <tbody>
          <tr><td>Students</td><td>${boysStats.n}</td><td>${girlsStats.n}</td></tr>
          <tr><td>Avg Height (cm)</td><td>${fmt(boysStats.avg_height,1)}</td><td>${fmt(girlsStats.avg_height,1)}</td></tr>
          <tr><td>Avg Weight (kg)</td><td>${fmt(boysStats.avg_weight,1)}</td><td>${fmt(girlsStats.avg_weight,1)}</td></tr>
          <tr><td>Avg BMI</td><td>${fmt(boysStats.avg_bmi,1)}</td><td>${fmt(girlsStats.avg_bmi,1)}</td></tr>
          <tr><td>Avg Fitness Score</td><td>${fmt(boysStats.avg_fitness,1)}</td><td>${fmt(girlsStats.avg_fitness,1)}</td></tr>
          <tr><td>Median Fitness Score</td><td>${fmt(boysStats.med_fitness,1)}</td><td>${fmt(girlsStats.med_fitness,1)}</td></tr>
          <tr><td>P75 Fitness Score</td><td>${fmt(boysStats.p75_fitness,1)}</td><td>${fmt(girlsStats.p75_fitness,1)}</td></tr>
          <tr><td>% With Missing Tests</td><td>${fmt(boysStats.pct_missing_any,1)}%</td><td>${fmt(girlsStats.pct_missing_any,1)}%</td></tr>
        </tbody>
      `;
    }

    function renderInsights(statsAll, boysStats, girlsStats){
      const el = document.getElementById("insights");
      const delta = (Number.isFinite(boysStats.avg_fitness) && Number.isFinite(girlsStats.avg_fitness))
        ? (boysStats.avg_fitness - girlsStats.avg_fitness)
        : NaN;

      const who = Number.isFinite(delta)
        ? (delta > 0 ? "Boys" : (delta < 0 ? "Girls" : "Neither—equal"))
        : null;

      const lines = [];
      lines.push(`Participation: ${statsAll.n} students; missing-test rate ${fmt(statsAll.pct_missing_any,1)}%.`);
      lines.push(`Overall fitness: avg ${fmt(statsAll.avg_fitness,1)} (median ${fmt(statsAll.med_fitness,1)}; P75 ${fmt(statsAll.p75_fitness,1)}).`);
      lines.push(`Gender split: Boys avg ${fmt(boysStats.avg_fitness,1)} vs Girls avg ${fmt(girlsStats.avg_fitness,1)}${Number.isFinite(delta) ? ` (${who} higher by ${fmt(Math.abs(delta),1)}).` : "."}`);
      lines.push(`Body measures: Avg height ${fmt(statsAll.avg_height,1)} cm, weight ${fmt(statsAll.avg_weight,1)} kg, BMI ${fmt(statsAll.avg_bmi,1)}.`);

      el.innerHTML = lines.map(x => `<li>${x}</li>`).join("");
    }

    function renderCharts(filteredRows, boysRows, girlsRows){
      destroyCharts();

      // hist
      const fitnessVals = filteredRows.map(r => toNum(r.fitnessscore));
      const hist = histogram(fitnessVals, 8);
      CH.hist = new Chart(document.getElementById("fitnessHist"), {
        type: "bar",
        data: { labels: hist.labels, datasets: [{ label: "Students", data: hist.counts }] },
        options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });

      // avg bar (boys vs girls)
      const labels = AVG_BAR.map(x => x[1]);
      const bData = AVG_BAR.map(x => mean(boysRows.map(r => toNum(r[x[0]]))));
      const gData = AVG_BAR.map(x => mean(girlsRows.map(r => toNum(r[x[0]]))));
      CH.bar = new Chart(document.getElementById("avgBar"), {
        type: "bar",
        data: { labels, datasets: [{ label:"Boys (avg)", data:bData }, { label:"Girls (avg)", data:gData }] },
        options: { responsive:true, plugins:{ legend:{ position:"bottom" } } }
      });

      // radar
      const rLabels = RADAR.map(x => x[1]);
      const rB = RADAR.map(x => mean(boysRows.map(r => toNum(r[x[0]]))));
      const rG = RADAR.map(x => mean(girlsRows.map(r => toNum(r[x[0]]))));
      CH.radar = new Chart(document.getElementById("radar"), {
        type:"radar",
        data:{ labels:rLabels, datasets:[{ label:"Boys (avg score)", data:rB }, { label:"Girls (avg score)", data:rG }] },
        options:{ responsive:true, plugins:{ legend:{ position:"bottom" } }, scales:{ r:{ beginAtZero:true } } }
      });
    }

    function applyFilters(){
      const grade = document.getElementById("gradeSel").value;
      const cls = document.getElementById("classSel").value;
      const sec = document.getElementById("sectionSel").value;
      const genderOnly = document.getElementById("genderSel").value; // Boy/Girl/""

      let rows = ALL_ROWS.slice();

      if (grade) rows = rows.filter(r => String(r.grade ?? "").trim() === grade);
      if (cls) rows = rows.filter(r => String(r.class ?? "").trim() === cls);
      if (sec) rows = rows.filter(r => String(r.section ?? "").trim() === sec);

      // If user chooses "Only Boys" or "Only Girls", we still show gender split table/charts,
      // but the filtered set becomes that gender. For split charts we use within the filtered set.
      if (genderOnly) rows = rows.filter(r => String(r.gender_norm ?? "") === genderOnly);

      const boysRows = rows.filter(r => r.gender_norm === "Boy");
      const girlsRows = rows.filter(r => r.gender_norm === "Girl");

      const statsAll = computeStats(rows);
      const boysStats = computeStats(boysRows);
      const girlsStats = computeStats(girlsRows);

      renderKPIs(statsAll);
      renderGenderTable(boysStats, girlsStats);
      renderInsights(statsAll, boysStats, girlsStats);
      renderCharts(rows, boysRows, girlsRows);
    }

    // Wire events
    ["gradeSel","classSel","sectionSel","genderSel"].forEach(id => {
      document.getElementById(id).addEventListener("change", applyFilters);
    });

    // Initial render (All)
    applyFilters();
  </script>
</body>
</html>
